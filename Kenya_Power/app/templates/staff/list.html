{% extends "base.html" %}

{% block title %}Staff Management - Kenya Power{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="mb-0">Staff Management</h4>
  <a href="{{ url_for('staff.add_staff') }}" class="btn btn-primary">
    <i class="bi bi-person-plus"></i> Add Staff Member
  </a>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
  <div class="card-body">
    <form method="GET" class="row g-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" name="search" value="{{ search }}"
                 placeholder="Search by name, username, or email...">
        </div>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="role">
          <option value="">All Roles</option>
          <option value="customer_service" {% if role_filter == 'customer_service' %}selected{% endif %}>Customer Care Agent</option>
          <option value="technician" {% if role_filter == 'technician' %}selected{% endif %}>Technician</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Staff Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
        <tr>
          <th>Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Role</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for user in staff.items %}
        <tr>
          <td><a href="{{ url_for('staff.view_staff', user_id=user.user_id) }}">{{ user.username }}</a></td>
          <td>{{ user.full_name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.phone or '-' }}</td>
          <td>
            {% if user.role == 'customer_service' %}
            <span class="badge bg-info">Customer Care Agent</span>
            {% elif user.role == 'technician' %}
            <span class="badge bg-warning text-dark">Technician</span>
            {% endif %}
          </td>
          <td>
            {% if user.is_active %}
            <span class="badge bg-success">Active</span>
            {% else %}
            <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </td>
          <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
          <td>
            <a href="{{ url_for('staff.view_staff', user_id=user.user_id) }}"
               class="btn btn-sm btn-outline-primary" title="View">
              <i class="bi bi-eye"></i>
            </a>
            <a href="{{ url_for('staff.edit_staff', user_id=user.user_id) }}"
               class="btn btn-sm btn-outline-secondary" title="Edit">
              <i class="bi bi-pencil"></i>
            </a>
            <form action="{{ url_for('staff.toggle_status', user_id=user.user_id) }}" method="POST" class="d-inline">
              {% if user.is_active %}
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Deactivate"
                      onclick="return confirm('Are you sure you want to deactivate this staff member?')">
                <i class="bi bi-person-x"></i>
              </button>
              {% else %}
              <button type="submit" class="btn btn-sm btn-outline-success" title="Activate"
                      onclick="return confirm('Are you sure you want to activate this staff member?')">
                <i class="bi bi-person-check"></i>
              </button>
              {% endif %}
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="text-center py-4 text-muted">No staff members found</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  {% if staff.pages > 1 %}
  <div class="card-footer">
    <nav>
      <ul class="pagination mb-0 justify-content-center">
        {% if staff.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('staff.list_staff', page=staff.prev_num, search=search, role=role_filter) }}">Previous</a>
        </li>
        {% endif %}

        {% for page_num in staff.iter_pages() %}
        {% if page_num %}
        <li class="page-item {% if page_num == staff.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('staff.list_staff', page=page_num, search=search, role=role_filter) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if staff.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('staff.list_staff', page=staff.next_num, search=search, role=role_filter) }}">Next</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}
