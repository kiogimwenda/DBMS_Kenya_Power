{% extends "base.html" %}

{% block title %}Maintenance - Kenya Power{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="mb-0">Maintenance Schedules</h4>
  <div>
    <a href="{{ url_for('maintenance.calendar') }}" class="btn btn-outline-primary me-2">
      <i class="bi bi-calendar3"></i> Calendar View
    </a>
    {% if current_user.role in ['admin', 'manager'] %}
    <a href="{{ url_for('maintenance.schedule_maintenance') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Schedule Maintenance
    </a>
    {% endif %}
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="GET" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select class="form-select" name="status">
          <option value="">All Statuses</option>
          <option value="scheduled" {% if status == 'scheduled' %}selected{% endif %}>Scheduled</option>
          <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
          <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
          <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
          <option value="postponed" {% if status == 'postponed' %}selected{% endif %}>Postponed</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Type</label>
        <select class="form-select" name="type">
          <option value="">All Types</option>
          <option value="preventive" {% if maintenance_type == 'preventive' %}selected{% endif %}>Preventive</option>
          <option value="corrective" {% if maintenance_type == 'corrective' %}selected{% endif %}>Corrective</option>
          <option value="emergency" {% if maintenance_type == 'emergency' %}selected{% endif %}>Emergency</option>
          <option value="inspection" {% if maintenance_type == 'inspection' %}selected{% endif %}>Inspection</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
      </div>
    </form>
  </div>
</div>

<!-- Maintenance Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Type</th>
          <th>Equipment</th>
          <th>Scheduled Date</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for schedule in schedules.items %}
        <tr>
          <td><a href="{{ url_for('maintenance.view_maintenance', maintenance_id=schedule.maintenance_id) }}">#{{ schedule.maintenance_id }}</a></td>
          <td>{{ schedule.title|truncate(30) }}</td>
          <td>{{ schedule.maintenance_type.title() }}</td>
          <td>{{ schedule.equipment_type.replace('_', ' ').title() }}</td>
          <td>{{ schedule.scheduled_date.strftime('%b %d, %Y') }}</td>
          <td><span class="priority-{{ schedule.priority }}">{{ schedule.priority.title() }}</span></td>
          <td><span class="badge status-{{ schedule.status }}">{{ schedule.status.title() }}</span></td>
          <td>{{ schedule.technician.full_name if schedule.technician else '-' }}</td>
          <td>
            <a href="{{ url_for('maintenance.view_maintenance', maintenance_id=schedule.maintenance_id) }}"
               class="btn btn-sm btn-outline-primary" title="View">
              <i class="bi bi-eye"></i>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="text-center py-4 text-muted">No maintenance schedules found</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  {% if schedules.pages > 1 %}
  <div class="card-footer">
    <nav>
      <ul class="pagination mb-0 justify-content-center">
        {% if schedules.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('maintenance.list_maintenance', page=schedules.prev_num, status=status, type=maintenance_type) }}">Previous</a>
        </li>
        {% endif %}

        {% for page_num in schedules.iter_pages() %}
        {% if page_num %}
        <li class="page-item {% if page_num == schedules.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('maintenance.list_maintenance', page=page_num, status=status, type=maintenance_type) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if schedules.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('maintenance.list_maintenance', page=schedules.next_num, status=status, type=maintenance_type) }}">Next</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}